name: Magento 2.4 Community Edition Docker container build
on:
  push:
  pull_request:
  schedule:
    - cron: '0 0 * * 1'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      COMPOSER_AUTH: ${{ secrets.COMPOSER_AUTH }}
    strategy:
      fail-fast: false
      matrix:
        cfg:
          - { PHP_VERSION: php84-fpm, MAGENTO_VERSION: 2.4.8-p3, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php84-fpm, MAGENTO_VERSION: 2.4.8-p3, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php83-fpm, MAGENTO_VERSION: 2.4.8-p3, SAMPLE_DATA: false }
          - { PHP_VERSION: php83-fpm, MAGENTO_VERSION: 2.4.8-p3, SAMPLE_DATA: true }
          - { PHP_VERSION: php84-fpm, MAGENTO_VERSION: 2.4.8-p2, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php84-fpm, MAGENTO_VERSION: 2.4.8-p2, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php83-fpm, MAGENTO_VERSION: 2.4.8-p2, SAMPLE_DATA: false }
          - { PHP_VERSION: php83-fpm, MAGENTO_VERSION: 2.4.8-p2, SAMPLE_DATA: true }
          - { PHP_VERSION: php84-fpm, MAGENTO_VERSION: 2.4.8-p1, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php84-fpm, MAGENTO_VERSION: 2.4.8-p1, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php83-fpm, MAGENTO_VERSION: 2.4.8-p1, SAMPLE_DATA: false }
          - { PHP_VERSION: php83-fpm, MAGENTO_VERSION: 2.4.8-p1, SAMPLE_DATA: true }
          - { PHP_VERSION: php84-fpm, MAGENTO_VERSION: 2.4.8, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php84-fpm, MAGENTO_VERSION: 2.4.8, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php83-fpm, MAGENTO_VERSION: 2.4.8, SAMPLE_DATA: false }
          - { PHP_VERSION: php83-fpm, MAGENTO_VERSION: 2.4.8, SAMPLE_DATA: true }
          - { PHP_VERSION: php83-fpm, MAGENTO_VERSION: 2.4.7-p8, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php83-fpm, MAGENTO_VERSION: 2.4.7-p8, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.7-p8, SAMPLE_DATA: false }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.7-p8, SAMPLE_DATA: true }
          - { PHP_VERSION: php83-fpm, MAGENTO_VERSION: 2.4.7-p7, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php83-fpm, MAGENTO_VERSION: 2.4.7-p7, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.7-p7, SAMPLE_DATA: false }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.7-p7, SAMPLE_DATA: true }
          - { PHP_VERSION: php83-fpm, MAGENTO_VERSION: 2.4.7-p6, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php83-fpm, MAGENTO_VERSION: 2.4.7-p6, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.7-p6, SAMPLE_DATA: false }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.7-p6, SAMPLE_DATA: true }
          - { PHP_VERSION: php83-fpm, MAGENTO_VERSION: 2.4.7-p5, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php83-fpm, MAGENTO_VERSION: 2.4.7-p5, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.7-p5, SAMPLE_DATA: false }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.7-p5, SAMPLE_DATA: true }
          - { PHP_VERSION: php83-fpm, MAGENTO_VERSION: 2.4.7-p4, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php83-fpm, MAGENTO_VERSION: 2.4.7-p4, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.7-p4, SAMPLE_DATA: false }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.7-p4, SAMPLE_DATA: true }
          - { PHP_VERSION: php83-fpm, MAGENTO_VERSION: 2.4.7-p3, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php83-fpm, MAGENTO_VERSION: 2.4.7-p3, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.7-p3, SAMPLE_DATA: false }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.7-p3, SAMPLE_DATA: true }
          - { PHP_VERSION: php83-fpm, MAGENTO_VERSION: 2.4.7-p2, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php83-fpm, MAGENTO_VERSION: 2.4.7-p2, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.7-p2, SAMPLE_DATA: false }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.7-p2, SAMPLE_DATA: true }
          - { PHP_VERSION: php83-fpm, MAGENTO_VERSION: 2.4.7-p1, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php83-fpm, MAGENTO_VERSION: 2.4.7-p1, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.7-p1, SAMPLE_DATA: false }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.7-p1, SAMPLE_DATA: true }
          - { PHP_VERSION: php83-fpm, MAGENTO_VERSION: 2.4.7, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php83-fpm, MAGENTO_VERSION: 2.4.7, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.7, SAMPLE_DATA: false }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.7, SAMPLE_DATA: true }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.6-p13, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.6-p13, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.6-p13, SAMPLE_DATA: false }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.6-p13, SAMPLE_DATA: true }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.6-p12, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.6-p12, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.6-p12, SAMPLE_DATA: false }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.6-p12, SAMPLE_DATA: true }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.6-p11, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.6-p11, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.6-p11, SAMPLE_DATA: false }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.6-p11, SAMPLE_DATA: true }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.6-p10, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.6-p10, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.6-p10, SAMPLE_DATA: false }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.6-p10, SAMPLE_DATA: true }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.6-p9, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.6-p9, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.6-p9, SAMPLE_DATA: false }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.6-p9, SAMPLE_DATA: true }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.6-p8, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.6-p8, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.6-p8, SAMPLE_DATA: false }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.6-p8, SAMPLE_DATA: true }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.6-p7, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.6-p7, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.6-p7, SAMPLE_DATA: false }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.6-p7, SAMPLE_DATA: true }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.6-p6, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.6-p6, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.6-p6, SAMPLE_DATA: false }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.6-p6, SAMPLE_DATA: true }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.6-p5, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.6-p5, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.6-p5, SAMPLE_DATA: false }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.6-p5, SAMPLE_DATA: true }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.6-p4, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.6-p4, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.6-p4, SAMPLE_DATA: false }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.6-p4, SAMPLE_DATA: true }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.6-p3, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.6-p3, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.6-p3, SAMPLE_DATA: false }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.6-p3, SAMPLE_DATA: true }
          # 2.4.6-p2 is disabled due to this error that keeps haunting me:
          # Connection "default" is not defined
#          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.6-p2, SAMPLE_DATA: false }
#          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.6-p2, SAMPLE_DATA: true }
#          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.6-p2, SAMPLE_DATA: false }
#          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.6-p2, SAMPLE_DATA: true }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.6-p1, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.6-p1, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.6-p1, SAMPLE_DATA: false }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.6-p1, SAMPLE_DATA: true }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.6, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php82-fpm, MAGENTO_VERSION: 2.4.6, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.6, SAMPLE_DATA: false }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.6, SAMPLE_DATA: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.5-p14, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.5-p14, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.5-p13, SAMPLE_DATA: false }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.5-p13, SAMPLE_DATA: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.5-p12, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.5-p12, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.5-p11, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.5-p11, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.5-p10, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.5-p10, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.5-p9, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.5-p9, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.5-p8, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.5-p8, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.5-p7, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.5-p7, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.5-p6, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.5-p6, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.5-p5, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.5-p5, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.5-p4, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.5-p4, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.5-p3, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.5-p3, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.5-p2, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.5-p2, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.5-p1, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.5-p1, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.5, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.5, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.4-p13, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.4-p13, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.4-p13, SAMPLE_DATA: false }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.4-p13, SAMPLE_DATA: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.4-p12, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.4-p12, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.4-p12, SAMPLE_DATA: false }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.4-p12, SAMPLE_DATA: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.4-p11, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.4-p11, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.4-p11, SAMPLE_DATA: false }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.4-p11, SAMPLE_DATA: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.4-p10, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.4-p10, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.4-p10, SAMPLE_DATA: false }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.4-p10, SAMPLE_DATA: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.4-p9, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.4-p9, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.4-p9, SAMPLE_DATA: false }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.4-p9, SAMPLE_DATA: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.4-p8, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.4-p8, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.4-p8, SAMPLE_DATA: false }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.4-p8, SAMPLE_DATA: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.4-p7, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.4-p7, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.4-p7, SAMPLE_DATA: false }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.4-p7, SAMPLE_DATA: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.4-p6, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.4-p6, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.4-p6, SAMPLE_DATA: false }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.4-p6, SAMPLE_DATA: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.4-p5, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.4-p5, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.4-p5, SAMPLE_DATA: false }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.4-p5, SAMPLE_DATA: true }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.4-p4, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.4-p4, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.4-p4, SAMPLE_DATA: false }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.4-p4, SAMPLE_DATA: true }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.4-p3, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.4-p3, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.4-p3, SAMPLE_DATA: false }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.4-p3, SAMPLE_DATA: true }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.4-p2, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.4-p2, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.4-p2, SAMPLE_DATA: false }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.4-p2, SAMPLE_DATA: true }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.4-p1, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.4-p1, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.4-p1, SAMPLE_DATA: false }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.4-p1, SAMPLE_DATA: true }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.4, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.4, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.4, SAMPLE_DATA: false }
          - { PHP_VERSION: php81-fpm, MAGENTO_VERSION: 2.4.4, SAMPLE_DATA: true }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.3-p2, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.3-p2, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php73-fpm, MAGENTO_VERSION: 2.4.3-p1, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php73-fpm, MAGENTO_VERSION: 2.4.3-p1, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.3-p1, SAMPLE_DATA: false }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.3-p1, SAMPLE_DATA: true }
          - { PHP_VERSION: php73-fpm, MAGENTO_VERSION: 2.4.3, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php73-fpm, MAGENTO_VERSION: 2.4.3, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.3, SAMPLE_DATA: false }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.3, SAMPLE_DATA: true }
          - { PHP_VERSION: php73-fpm, MAGENTO_VERSION: 2.4.2-p2, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php73-fpm, MAGENTO_VERSION: 2.4.2-p2, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.2-p2, SAMPLE_DATA: false }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.2-p2, SAMPLE_DATA: true }
          - { PHP_VERSION: php73-fpm, MAGENTO_VERSION: 2.4.2-p1, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php73-fpm, MAGENTO_VERSION: 2.4.2-p1, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.2-p1, SAMPLE_DATA: false }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.2-p1, SAMPLE_DATA: true }
          - { PHP_VERSION: php73-fpm, MAGENTO_VERSION: 2.4.2, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php73-fpm, MAGENTO_VERSION: 2.4.2, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.2, SAMPLE_DATA: false }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.2, SAMPLE_DATA: true }
          - { PHP_VERSION: php73-fpm, MAGENTO_VERSION: 2.4.1-p1, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php73-fpm, MAGENTO_VERSION: 2.4.1-p1, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.1-p1, SAMPLE_DATA: false }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.1-p1, SAMPLE_DATA: true }
          - { PHP_VERSION: php73-fpm, MAGENTO_VERSION: 2.4.1, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php73-fpm, MAGENTO_VERSION: 2.4.1, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.1, SAMPLE_DATA: false }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.1, SAMPLE_DATA: true }
          - { PHP_VERSION: php73-fpm, MAGENTO_VERSION: 2.4.0-p1, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php73-fpm, MAGENTO_VERSION: 2.4.0-p1, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.0-p1, SAMPLE_DATA: false }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.0-p1, SAMPLE_DATA: true }
          - { PHP_VERSION: php73-fpm, MAGENTO_VERSION: 2.4.0, SAMPLE_DATA: false, MAIN_VERSION: true }
          - { PHP_VERSION: php73-fpm, MAGENTO_VERSION: 2.4.0, SAMPLE_DATA: true, MAIN_VERSION: true }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.0, SAMPLE_DATA: false }
          - { PHP_VERSION: php74-fpm, MAGENTO_VERSION: 2.4.0, SAMPLE_DATA: true }
    steps:
    - uses: actions/checkout@v4

    # Step 1: Build the docker image
    - name: Compute tag
      id: tags
      run: |
        tag="${{ matrix.cfg.PHP_VERSION }}-magento${{ matrix.cfg.MAGENTO_VERSION }}"
        main_tag="magento${{ matrix.cfg.MAGENTO_VERSION }}"

        if [[ "${{ matrix.cfg.SAMPLE_DATA }}" == "true" ]]; then
          tag="${tag}-sample-data"
          main_tag="${main_tag}-sample-data"
        fi

        echo "tag=$tag" >> "$GITHUB_OUTPUT"
        echo "main_tag=$main_tag" >> "$GITHUB_OUTPUT"

    - name: Build the Docker image
      run:
        docker build magento -f magento/Dockerfile-2.4
        -t michielgerritsen/magento-project-community-edition:${{ steps.tags.outputs.tag }}
        -t ghcr.io/${{ github.repository }}/magento-project-community-edition:${{ steps.tags.outputs.tag }}
        -t ghcr.io/${{ github.repository }}/magento-project-community-edition:${{ steps.tags.outputs.main_tag }}
        --build-arg COMPOSER_AUTH="$COMPOSER_AUTH"
        --build-arg MAGENTO_VERSION=${{ matrix.cfg.MAGENTO_VERSION }}
        --build-arg PHP_VERSION=${{ matrix.cfg.PHP_VERSION }}
        --build-arg SAMPLE_DATA=${{ matrix.cfg.SAMPLE_DATA }}

    # Step 2: Test the docker image
    - name: Start the docker image
      run:
        docker run --memory=4G --detach --name magento-project-community-edition
        michielgerritsen/magento-project-community-edition:${{ steps.tags.outputs.tag }}

    - name: Create the dummy test directory
      run: docker exec magento-project-community-edition mkdir -p /data/app/code/MichielGerritsen/Magento2ExtensionIntegrationTest/Test/Integration

    - name: Copy the example test module
      run: |
        docker exec magento-project-community-edition mkdir -p /data/extensions/MichielGerritsen-ExampleTest/Test/Integration/
        docker cp Test/composer.json magento-project-community-edition:/data/extensions/MichielGerritsen-ExampleTest/
        docker cp Test/ExampleTest.php magento-project-community-edition:/data/extensions/MichielGerritsen-ExampleTest/Test/Integration/

    - name: Install the example test module
      run: docker exec magento-project-community-edition composer require michielgerritsen/exampletest:@dev

    - name: Enable developer mode
      run: docker exec magento-project-community-edition ./retry "bin/magento deploy:mode:set developer"

    - name: Run setup:di:compile
      run: docker exec magento-project-community-edition ./retry "php bin/magento setup:di:compile"

    - name: Run the example test
      run: docker exec magento-project-community-edition bash -c "cd /data/dev/tests/integration/ && ../../../vendor/bin/phpunit /data/vendor/michielgerritsen/exampletest/Test/Integration/ExampleTest.php"

    # Step 3: Upload the images to Docker Hub and ghcr.io.
    - name: Push the image to GitHub Container Registry
      if: github.ref == 'refs/heads/master'
      env:
        MAIN_VERSION: ${{ matrix.cfg.MAIN_VERSION }}
      run: |
        echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
        docker push ghcr.io/${{ github.repository }}/magento-project-community-edition:${{ steps.tags.outputs.tag }}
        if [[ -n "${MAIN_VERSION}" ]]; then
          docker push ghcr.io/${{ github.repository }}/magento-project-community-edition:${{ steps.tags.outputs.main_tag }}
        fi

    - name: Push the image to Docker hub
      if: github.ref == 'refs/heads/master'
      run: |
        echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
        docker push michielgerritsen/magento-project-community-edition:${{ steps.tags.outputs.tag }}

    - name: Dump Docker logs files (on failure)
      if: failure()
      run: |
        mkdir failure-logs
        docker logs magento-project-community-edition > failure-logs/docker.log
        docker cp magento-project-community-edition:/data/var/log failure-logs/var/log

    - name: Upload failure artifacts
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: failure-artifacts-${{ steps.tags.outputs.tag }}
        path: |
          failure-logs
